# 🎬 쇼츠 영상 자동 생성 도구

TTS 음성과 대본을 기반으로 자막이 자동으로 싱크되는 쇼츠 영상을 생성하는 도구입니다.

## ✨ 주요 기능

- 🎙️ **Whisper 기반 음성 분석**: 단어 단위 타임스탬프 추출
- 📝 **자동 자막 생성**: TTS와 완벽하게 동기화
- 🎬 **영상 자동 편집**: 대본 라인별 영상 매핑 및 속도 조절
- ✂️ **자연스러운 분할**: TTS pause 기반 자막 분할
- 🎯 **깜빡임 없는 전환**: 자막과 영상이 끊김 없이 연속
- 🧠 **대본-Whisper 매칭 안정화**: DP(시퀀스 정렬) + 편집거리/자모 유사도 + 라인 confidence 기반 폴백
- 🛡️ **자막 타임라인 안전장치**: chunk 타이밍 역행/음수 duration 방지 (클램프/단조 보정)
- 🔧 **폴백 오동작 완화**: 저신뢰 라인이라도 경계(start/end)가 정상이고 겹침이 없으면 word 타이밍 유지
- 🔀 **라인 겹침 보정 개선**: 이전 라인 end를 보존하고 다음 라인 start만 뒤로 이동해 경계 왜곡 최소화

## 📦 설치

권장 파이썬 버전: `3.12`

```bash
pip install "moviepy<2" openai-whisper numpy streamlit Pillow
```

## 📁 폴더 구조

```
gen-vd/
├── main.py           # 메인 스크립트
├── download.wav      # TTS 오디오 파일 (기본값)
├── bg/               # 배경음악 폴더 (선택사항, 실행 시 랜덤 1곡 선택)
│   ├── track1.mp3
│   ├── track2.wav
│   └── ...
├── bg.mp3            # 기존 단일 배경음악 파일 (폴백, 선택사항)
└── vd/               # 비디오 파일 폴더
    ├── 1.mp4
    ├── 2.mp4
    ├── 3.mp4
    └── ...
```

## 🚀 사용 방법

### 1. 비디오 파일 준비

`vd` 폴더에 순서대로 비디오 파일을 넣으세요:

- 파일명은 숫자 순서대로 (1.mp4, 2.mp4, 3.mp4...)
- 대본 라인 수와 동일한 개수 권장
- 지원 포맷: .mp4, .avi, .mov, .mkv, .webm, .flv

### 2. 오디오 파일 준비

TTS로 생성한 오디오 파일을 `download.wav`로 저장하거나,
실행 시 다른 경로를 입력하세요.

### 2-1. 배경음악 추가 (선택사항)

`bg` 폴더에 배경음악 파일을 넣으면 실행 시 랜덤 1곡이 선택되어 TTS와 함께 재생됩니다:

- 파일 형식: .mp3, .wav, .m4a 등
- 자동으로 영상 길이에 맞춰 루프 재생
- 볼륨 조절 가능 (기본값: 15%)
- BGM이 짧으면 자동으로 반복 재생
- `bg` 폴더가 비어 있으면 `bg.mp3`를 폴백으로 사용

### 3. 스크립트 실행

```bash
python3 main.py
```

### 3-1. Streamlit GUI 실행 (선택)

CLI 대신 GUI로 실행하려면:

```bash
streamlit run streamlit_app.py
```

- 오디오 파일: `오디오 선택` 버튼으로 파일 선택 가능
- 비디오 폴더: `폴더 선택` 버튼으로 폴더 선택 가능
- 선택기가 동작하지 않는 환경에서는 경로를 직접 입력

### 4. 대본 입력

프로그램이 시작되면 대본을 한 줄씩 입력합니다:

```
📝 대본 입력
==================================================
여러 줄의 대본을 입력하세요.
각 줄이 하나의 장면이 됩니다.
여러 줄을 한 번에 붙여넣게 하면 자동으로 입력됩니다.
입력 완료 후 빈 줄에서 Enter를 누르세요.
==================================================
[1] 잠깐! 비행기 탔는데 설마 그냥 폰 켜둔 거 아니지?
[2] 그거 안 끄면 조종사 헤드셋에서 무슨 소리 나는지 알아?
[3] 지지직~ 삐이익! 마치 스피커 옆에 폰 뒀을 때 나는 기분 나쁜 잡음이 들린대.
[4]

(빈 줄에서 Enter를 눌러 입력 완료)
```

### 5. 생성 시작

확인 후 `y`를 입력하면 영상 생성이 시작됩니다.

```
📋 설정 요약:
   🎵 오디오: download.wav
   📝 대본: 7줄
   🎬 영상: 7개
==================================================

영상 생성을 시작하시겠습니까? (y/n): y
```

### 6. 완성!

`final_shorts_autofit.mp4` 파일이 생성됩니다.

## ⚙️ 설정 변경

`main.py` 파일에서 다음 값들을 조정할 수 있습니다:

```python
TARGET_SIZE = (1080, 1920)  # 해상도 (세로)
FONT_SIZE = 65              # 자막 크기
MAX_LINE_CHARS = 10         # 자막 한 줄 최대 글자 수
MIN_SPEED = 0.6             # 최소 재생 속도
MAX_SPEED = 1.5             # 최대 재생 속도
BGM_FOLDER = "bg"           # 배경음악 폴더 경로 (랜덤 선택)
BGM_LEGACY_PATH = "bg.mp3"  # 기존 단일 파일 폴백 경로
BGM_VOLUME = 0.15           # 배경음악 볼륨 (0.0 ~ 1.0)

# 대본-Whisper 매칭(타임스탬프) 정렬 설정
USE_DP_ALIGNMENT = True
DP_USE_JAMO = True              # 한글 자모 분해 기반 유사도
DP_MIN_ASSIGN_SIM = 0.62        # 토큰-토큰 매칭 최소 유사도(이하면 미할당)
LINE_FALLBACK_MIN_CONF = 0.60   # 라인 매칭 confidence가 낮으면 Whisper segment 타이밍으로 폴백
```

## 🎯 작동 원리

1. **음성 분석**: Whisper로 TTS 음성 분석 및 단어별 타임스탬프 추출
2. **자막/라인 매칭**: DP(시퀀스 정렬)로 대본 토큰열과 Whisper 단어열을 단조 정렬
3. **유사도 계산**: 편집거리(Levenshtein) + (옵션) 한글 자모 분해 기반 similarity로 오타/발음 차이를 흡수
4. **폴백**: 라인별 confidence가 낮고(또는 매칭 0/경계 누락/이전 라인 겹침) 실패 징후가 있을 때만 Whisper segment start/end를 사용
5. **자연스러운 분할**: TTS pause(0.2초 이상)를 기준으로 자막 분할
6. **타이밍 조정**: 자막/영상 간격을 0으로 만들어 깜빡임 제거
7. **영상 편집**: 각 라인별 영상 매핑 및 속도 자동 조절
8. **최종 합성**: 자막과 영상을 합성하여 최종 영상 생성

## 💡 팁

### 자막이 너무 길게 표시되는 경우

`MAX_LINE_CHARS` 값을 줄이세요 (예: 15)

### 영상이 너무 빠르게/느리게 재생되는 경우

`MIN_SPEED`, `MAX_SPEED` 값을 조정하세요

### 자막 분할이 부자연스러운 경우

TTS 생성 시 문장 간 pause를 더 명확하게 설정하세요

### 대본-Whisper 매칭이 어긋나는 경우

- 실행 로그의 라인별 출력에 `conf:0.xx, sim:0.xx`가 표시됩니다.
- 특정 라인이 `conf`가 낮아도 `matched_words>0`이고 경계가 정상이며 이전 라인과 겹치지 않으면 word 타임스탬프를 유지합니다.
- 특정 라인이 `conf`가 낮아 폴백되는 경우 `LINE_FALLBACK_MIN_CONF`를 낮추면 word 타임스탬프를 더 많이 쓰게 됩니다(공격적).
- 반대로 `LINE_FALLBACK_MIN_CONF`를 높이면 segment 폴백을 더 자주 써서 안정성을 우선합니다(보수적).
- 발음/오타/띄어쓰기 이슈가 많으면 `DP_USE_JAMO=True`가 유리합니다.
- 숫자/영문(SCP 코드 등)에서 Whisper 인식이 크게 틀리면, 매칭은 “정렬”만 가능하고 “정답 복원”은 어렵습니다. 이 경우 폴백(segments) 전략이 더 안정적입니다.

### BGM이 너무 크거나 작은 경우

실행 시 BGM 볼륨을 조절하거나, `BGM_VOLUME` 값을 변경하세요

- 너무 큼: 0.05 ~ 0.10 (5~10%)
- 적당함: 0.15 ~ 0.20 (15~20%)
- 크게: 0.25 ~ 0.30 (25~30%)

### BGM을 사용하지 않으려면

- 실행 시 BGM 추가 여부에서 `n` 입력
- 또는 `bg` 폴더를 비우고 `bg.mp3` 파일을 삭제/이름 변경

## 🐛 문제 해결

### "영상 파일을 찾을 수 없습니다"

- `vd` 폴더가 있는지 확인
- 폴더 내에 비디오 파일이 있는지 확인
- 파일 확장자가 지원되는지 확인 (.mp4 권장)

### "오디오 파일을 찾을 수 없습니다"

- `download.wav` 파일이 있는지 확인
- 실행 시 올바른 경로를 입력했는지 확인

### 자막과 음성이 맞지 않는 경우

- TTS가 대본과 정확히 일치하는지 확인
- Whisper가 음성을 정확히 인식했는지 로그 확인

## 📄 라이선스

개인 및 상업적 용도로 자유롭게 사용 가능합니다.
